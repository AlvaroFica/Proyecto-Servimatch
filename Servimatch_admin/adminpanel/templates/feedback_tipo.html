{% extends 'base_admin.html' %}
{% block title %}EstadÃ­sticas{% endblock %}
{% block page_title %}EstadÃ­sticas Globales{% endblock %}

{% block content %}
<div class="dashboard-container">
  <div class="graf-menu">
    <button data-grafico="grafFeedback" class="graf-btn active">ðŸ“Š Feedback</button>
    <button data-grafico="grafBoletas" class="graf-btn">ðŸ“„ Boletas</button>
    <button data-grafico="grafServicios" class="graf-btn">ðŸ›  Servicios</button>
  </div>

  <div class="graf-card">
    <canvas id="grafFeedback" class="graf-canvas show"></canvas>
    <canvas id="grafBoletas" class="graf-canvas"></canvas>
    <canvas id="grafServicios" class="graf-canvas"></canvas>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  function main() {
    const API_BASE_URL = 'http://localhost:8000/api';

    const config = {
      grafFeedback: ['bar', `${API_BASE_URL}/graficos/feedback-tipo/`, 'Feedback por Tipo', ['#6c63ff', '#ffce56', '#ff6384']],
      grafBoletas: ['doughnut', `${API_BASE_URL}/graficos/boletas-por-estado/`, 'Boletas por Estado'],
      grafServicios: ['bar', `${API_BASE_URL}/graficos/servicios-populares/`, 'Servicios Populares']
    };

    let charts = {};

    function mostrarYRenderizar(id) {
      // Ocultar todos los canvas
      document.querySelectorAll('.graf-canvas').forEach(c => {
        c.style.display = 'none';
        c.classList.remove('show');
      });

      // Mostrar el canvas seleccionado
      const canvas = document.getElementById(id);
      canvas.style.display = 'block';
      setTimeout(() => canvas.classList.add('show'), 10);

      // Si no se ha renderizado aÃºn, hacerlo
      if (!charts[id]) {
        const [type, url, label, colors] = config[id];
        fetch(url).then(r => r.json()).then(data => {
          charts[id] = new Chart(canvas, {
            type: type,
            data: {
              labels: data.labels,
              datasets: [{
                label: label,
                data: data.cantidades,
                backgroundColor: colors || 'rgba(75, 60, 145, 0.7)',
                borderRadius: type === 'bar' ? 10 : 0
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              plugins: {
                legend: { display: true, position: 'bottom' },
                title: { display: true, text: label }
              },
              scales: type === 'bar' ? {
                y: { beginAtZero: true },
                x: {}
              } : {}
            }
          });
        });
      }
    }

    // Eventos en botones
    document.querySelectorAll('.graf-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-grafico');

        // Activar botÃ³n
        document.querySelectorAll('.graf-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // Mostrar grÃ¡fico
        mostrarYRenderizar(id);
      });
    });

    // Activar por defecto
    document.querySelector('[data-grafico="grafFeedback"]').classList.add('active');
    mostrarYRenderizar('grafFeedback');
  }

  // Ejecutar cuando el DOM estÃ© listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', main);
  } else {
    main();
  }
</script>
{% endblock %}
